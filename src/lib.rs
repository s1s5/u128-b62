const BASE62: &str = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
static CHAR_TO_INDEX: phf::Map<char, u8> = phf::phf_map! {
    '0' => 0,
    '1' => 1,
    '2' => 2,
    '3' => 3,
    '4' => 4,
    '5' => 5,
    '6' => 6,
    '7' => 7,
    '8' => 8,
    '9' => 9,
    'A' => 10,
    'B' => 11,
    'C' => 12,
    'D' => 13,
    'E' => 14,
    'F' => 15,
    'G' => 16,
    'H' => 17,
    'I' => 18,
    'J' => 19,
    'K' => 20,
    'L' => 21,
    'M' => 22,
    'N' => 23,
    'O' => 24,
    'P' => 25,
    'Q' => 26,
    'R' => 27,
    'S' => 28,
    'T' => 29,
    'U' => 30,
    'V' => 31,
    'W' => 32,
    'X' => 33,
    'Y' => 34,
    'Z' => 35,
    'a' => 36,
    'b' => 37,
    'c' => 38,
    'd' => 39,
    'e' => 40,
    'f' => 41,
    'g' => 42,
    'h' => 43,
    'i' => 44,
    'j' => 45,
    'k' => 46,
    'l' => 47,
    'm' => 48,
    'n' => 49,
    'o' => 50,
    'p' => 51,
    'q' => 52,
    'r' => 53,
    's' => 54,
    't' => 55,
    'u' => 56,
    'v' => 57,
    'w' => 58,
    'x' => 59,
    'y' => 60,
    'z' => 61,
};

pub fn encode(n: u128) -> String {
    let u8_to_alphabet = BASE62.as_bytes();
    let mut res = vec!['0'; 22];
    let mut n = n;
    let mut index: usize = 22;
    while n > 0 {
        index -= 1;
        let rem = (n % 62) as usize;
        n /= 62;
        res[index] = u8_to_alphabet[rem] as char;
    }
    res.into_iter().collect()
}

pub fn decode(s: &str) -> Result<u128, char> {
    let mut n: u128 = 0;
    for c in s.chars() {
        n *= 62;
        n += CHAR_TO_INDEX.get(&c).copied().ok_or(c)? as u128;
    }
    Ok(n)
}

#[cfg(test)]
mod tests {
    #[test]
    fn test_base62_encode_decode() {
        for n in [
            0,
            1,
            2,
            10,
            20,
            30,
            40,
            100,
            150,
            200,
            300,
            400,
            500,
            1000,
            1500,
            2000,
            3000,
            4000,
            5000,
            10000,
            15000,
            20000,
            30000,
            40000,
            50000,
            100000,
            150000,
            200000,
            300000,
            400000,
            500000,
            1000000,
            1500000,
            2000000,
            3000000,
            4000000,
            5000000,
            10000000,
            15000000,
            20000000,
            30000000,
            40000000,
            50000000,
            100000000,
            150000000,
            200000000,
            300000000,
            400000000,
            500000000,
            1000000000,
            1500000000,
            2000000000,
            3000000000,
            4000000000,
            5000000000,
            10000000000,
            15000000000,
            20000000000,
            30000000000,
            40000000000,
            50000000000,
            100000000000,
            150000000000,
            200000000000,
            300000000000,
            400000000000,
            500000000000,
            1000000000000,
            1500000000000,
            2000000000000,
            3000000000000,
            4000000000000,
            5000000000000,
            10000000000000,
            15000000000000,
            20000000000000,
            30000000000000,
            40000000000000,
            50000000000000,
            100000000000000,
            150000000000000,
            200000000000000,
            300000000000000,
            400000000000000,
            500000000000000,
            1000000000000000,
            1500000000000000,
            2000000000000000,
            3000000000000000,
            4000000000000000,
            5000000000000000,
            10000000000000000,
            15000000000000000,
            20000000000000000,
            30000000000000000,
            40000000000000000,
            50000000000000000,
            100000000000000000,
            150000000000000000,
            200000000000000000,
            300000000000000000,
            400000000000000000,
            500000000000000000,
            1000000000000000000,
            1500000000000000000,
            2000000000000000000,
            3000000000000000000,
            4000000000000000000,
            5000000000000000000,
            10000000000000000000,
            15000000000000000000,
            20000000000000000000,
            30000000000000000000,
            40000000000000000000,
            50000000000000000000,
            100000000000000000000,
            150000000000000000000,
            200000000000000000000,
            300000000000000000000,
            400000000000000000000,
            500000000000000000000,
        ] {
            let s = super::encode(n);
            let n2 = super::decode(&s).unwrap();
            assert_eq!(n, n2);
        }

        for _ in 0..100 {
            let n = uuid::Uuid::new_v4().as_u128();
            let s = super::encode(n);
            let n2 = super::decode(&s).unwrap();
            // println!("n: {}, s: {} n2: {}", n, s, n2);
            assert_eq!(n, n2);
        }

        for _ in 0..100 {
            let id: uuid::Uuid = ulid::Ulid::new().into();
            let n = id.as_u128();
            let s = super::encode(n);
            let n2 = super::decode(&s).unwrap();
            println!("n: {}, s: {} n2: {}", n, s, n2);
            assert_eq!(n, n2);
        }
    }
}
